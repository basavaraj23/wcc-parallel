apiVersion: batch/v1
kind: CronJob
metadata:
  labels:
    {{- include "common.labels" . | nindent 4 }}
  name: {{ .Chart.Name }}-cleanup-redis
spec:
  concurrencyPolicy: Allow
  failedJobsHistoryLimit: 1
  jobTemplate:
    metadata:
      creationTimestamp: null
      labels:
        {{- include "common.selectorLabels" . | nindent 8 }}
    spec:
      template:
        metadata:
          annotations:
            cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
        spec:
          containers:
          - command:
            - /usr/local/bin/node
            - dist/cleanup-redis.js
            env:
            - name: APOCALYPSE_API_REDIS
              value: redis://{{ .Values.ranker_redis_addr }}
            - name: APOCALYPSE_API_CAMPAIGN_CLEANUP_CUTOFF
              value: "{{ .Values.cleanup_redis.campaign_cutoff }}"
            - name: APOCALYPSE_API_SEASON_CLEANUP_CUTOFF
              value: "{{ .Values.cleanup_redis.season_cutoff }}"
            - name: APOCALYPSE_API_CLEANUP_REDIS_DRY_RUN
              value: "{{ .Values.cleanup_redis.dry_run }}"
            - name: APOCALYPSE_API_RAW_DATA_URL
              value: {{ .Values.raw_data_url }}
            - name: APOCALYPSE_API_TOURNAMENT_SCHEDULE_URL
              value: {{ .Values.tournament_schedule_url }}
            - name: APOCALYPSE_API_LIVE_EVENTS_URL
              value: {{ .Values.live_events_url }}
            - name: APOCALYPSE_API_TEST_LIVE_EVENTS_URL
              value: {{ .Values.live_events_test_url }}
            - name: APOCALYPSE_API_GACHA_TABLES
              value: {{ .Values.gacha_tables }}
            image: "{{ .Values.image.repository }}/{{ .Chart.Name }}:{{ .Values.image.tag }}"
            imagePullPolicy: Always
            name: "{{ .Chart.Name }}-cleanup-redis"
            resources:
              requests:
                cpu: "1"
                memory: 1600Mi
            terminationMessagePath: /dev/termination-log
            terminationMessagePolicy: File
            volumeMounts:
              - mountPath: /etc/service-account
                name: service-account
                readOnly: true
          dnsPolicy: ClusterFirst
          restartPolicy: Never
          serviceAccount: {{ .Values.service_account.name }}
          serviceAccountName: {{ .Values.service_account.name }}
          terminationGracePeriodSeconds: 60
          volumes:
            - name: service-account
              secret:
                defaultMode: 420
                secretName: apocalypse-account-key
  schedule: 0 5 * * * # Every day @ 05:00
  successfulJobsHistoryLimit: 1